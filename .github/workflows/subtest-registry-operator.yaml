name: "[Subtest] Operator Release"
run-name: "[Subtest] Operator Release on OCP ${{ inputs.cluster-version }}"
on:
  workflow_dispatch:
    inputs:
      # Test cluster:
      cluster-name:
        type: string
        description: >-
          Name of the test cluster. Can be a new cluster created by this workflow, or an existing cluster.
        required: true
        default: ci419
      skip-provision-cluster:
        type: boolean
        description: Use an existing test cluster.
        required: true
        default: false
      cluster-version:
        type: choice
        description: Version of the test cluster (required if not using an existing cluster).
        options:
          - "4.16"
          - "4.19"
        required: false
        default: "4.19"
      # Test configuration:
      release-version:
        type: string
        description: Upstream version that the release was based on.
        required: true
      tests-tag:
        type: string
        description: Git ref to use when checking out the testsuite sources. Should either be the same as the upstream version, or `main`.
        required: true
        default: main
      # Test artifacts:
      operatorImage:
        type: string
        description: Operator image (optional - if not provided, the image from the upstream version will be used).
        required: false
      appImage:
        type: string
        description: Application image (optional - if not provided, the image from the upstream version will be used).
        required: false
      uiImage:
        type: string
        description: UI image (optional - if not provided, the image from the upstream version will be used).
        required: false
      # OLM
      artifact-cluster-name:
        type: string
        description: >-
          Name of the artifact cluster where the downstream catalog image is hosted. 
          Catalog images must be prepared before running this test, see docs/Operator-Testing.md for details. 
          If left empty, it is assumed that a publicly available (upstream) catalog image is used.
        required: false
      catalog-image:
        type: string
        description: >-
          Upstream or downstream catalog image.
          Upstream OLM catalog image can be the latest one, i.e. `quay.io/apicurio/apicurio-registry-3-operator-catalog:latest`.
          Downstream catalog image is assumed to be hosted on the artifact cluster, 
          e.g. `image-registry-infra.apps.art.apicurio-testing.org/rh-osbs/iib:1234567`.
        required: true
      package-version:
        type: string
        description: >-
          CSV package version to install from the catalog image. For downstream, include the rebuild suffix, e.g. `3.1.4-r1`.
        required: true
      # Other
      destroy-test-cluster:
        type: boolean
        description: >-
          Destroy the test cluster after the tests have completed.
          Can be set to `false` when you want to reuse the test cluster multiple times.
          Does not have any effect if using an existing cluster already.
        required: true
        default: true
  # Same parameters as above, see the descriptions.
  workflow_call:
    inputs:
      cluster-name:
        type: string
        required: true
      skip-provision-cluster:
        type: boolean
        required: true
      cluster-version:
        type: string
        required: false
      release-version:
        type: string
        required: true
      tests-tag:
        type: string
        required: true
      operatorImage:
        type: string
        required: false
      appImage:
        type: string
        required: false
      uiImage:
        type: string
        required: false
      artifact-cluster-name:
        type: string
        required: false
      catalog-image:
        type: string
        required: true
      package-version:
        type: string
        required: true
      destroy-test-cluster:
        type: boolean
        required: true

# Prevent multiple runs for the same cluster:
#   - We're using OLM and using multiple catalog sources would have to be handled carefully,
#     and would pose a risk of interfering with other tests runs.
#   - ApicurioRegistry3 CRDs would be installed multiple times possibly overwrite each other.
concurrency:
  group: subtest-registry-operator-${{ inputs.cluster-name }}
  cancel-in-progress: false

jobs:

  record-start-time:
    name: Record start time
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      start-time: ${{ steps.get-start-time.outputs.start-time }}
    steps:

      - name: Get Workflow Start Time
        id: get-start-time
        run: |
          START_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          echo "start-time=$START_TIME" >> $GITHUB_OUTPUT
          echo "Workflow start time: $START_TIME"


  process-inputs:
    name: Process inputs
    runs-on: ubuntu-latest
    needs: record-start-time
    outputs:
      catalog-image: ${{ steps.transform-catalog-image.outputs.catalog-image }}
    if: >-
      !cancelled() && needs.record-start-time.result == 'success'
    steps:

      - name: Print Workflow Inputs
        run: |
          echo "ðŸ“‹ Workflow Input Parameters:"
          echo "  cluster-name: ${{ inputs.cluster-name }}"
          echo "  skip-provision-cluster: ${{ inputs.skip-provision-cluster }}"
          echo "  cluster-version: ${{ inputs.cluster-version }}"
          echo "  release-version: ${{ inputs.release-version }}"
          echo "  tests-tag: ${{ inputs.tests-tag }}"
          echo "  operatorImage: ${{ inputs.operatorImage }}"
          echo "  appImage: ${{ inputs.appImage }}"
          echo "  uiImage: ${{ inputs.uiImage }}"
          echo "  artifact-cluster-name: ${{ inputs.artifact-cluster-name }}"
          echo "  catalog-image: ${{ inputs.catalog-image }}"
          echo "  package-version: ${{ inputs.package-version }}"
          echo "  destroy-test-cluster: ${{ inputs.destroy-test-cluster }}"

      - name: Transform catalog image URL
        id: transform-catalog-image
        run: |
          CATALOG_IMAGE="${{ inputs.catalog-image }}"
          ARTIFACT_CLUSTER="${{ inputs.artifact-cluster-name }}"
          
          # Only transform if artifact-cluster-name is provided and catalog image uses registry-proxy:
          if [[ -n "$ARTIFACT_CLUSTER" && "$CATALOG_IMAGE" == registry-proxy.engineering.redhat.com/* ]]; then
            # Transform the URL
            TRANSFORMED_IMAGE="${CATALOG_IMAGE/registry-proxy.engineering.redhat.com/image-registry-infra.apps.$ARTIFACT_CLUSTER.apicurio-testing.org}"
          
            echo "âš ï¸  WARNING: Catalog image URL was transformed:"
            echo "  Original: $CATALOG_IMAGE"
            echo "  Transformed: $TRANSFORMED_IMAGE"
          
            echo "catalog-image=$TRANSFORMED_IMAGE" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  Catalog image URL does not need transformation."
            echo "catalog-image=$CATALOG_IMAGE" >> $GITHUB_OUTPUT
          fi

      - name: Validate cluster configuration
        run: |
          if [[ "${{ inputs.skip-provision-cluster }}" == "false" && -z "${{ inputs.cluster-version }}" ]]; then
            echo "âŒ Error: cluster-version is required when skip-provision-cluster is false"
            exit 1
          fi
          echo "âœ… Input validation passed"


  provision-cluster:
    name: Provision cluster
    uses: ./.github/workflows/infra-provision-cluster.yaml
    needs: process-inputs
    if: >-
      !cancelled() && needs.process-inputs.result == 'success' && !inputs.skip-provision-cluster
    with:
      cluster-name: ${{ inputs.cluster-name }}
      cluster-version: ${{ inputs.cluster-version }}
      control-nodes: 1 # Try with 1 control node to reduce resource usage. TODO: Adjust later if needed.
      compute-nodes: 2
      force: true
    secrets: inherit


  test:
    name: Operator tests
    runs-on: ubuntu-latest
    timeout-minutes: 150 # TODO: Hopefully not more. Adjust later.
    needs:
      - process-inputs
      - provision-cluster
    if: >-
      !cancelled()
        && (needs.provision-cluster.result == 'success' || needs.provision-cluster.result == 'skipped')
        && needs.process-inputs.result == 'success'

    steps:

      - name: Checkout ${{ github.ref }}
        uses: actions/checkout@v4

      - name: Restore cluster state
        uses: ./.github/actions/restore-cluster-state
        with:
          github-token: ${{ secrets.ACCESS_TOKEN }}
          cluster-name: ${{ inputs.cluster-name }}

      - name: Configure env. variables
        run: |
          echo "WORKSPACE=$PWD" >> $GITHUB_ENV
          echo "DOCKER_CONFIG=cache/clusters/${{ inputs.cluster-name }}/.docker" >> $GITHUB_ENV

      - name: Configure image registry pull secret
        if: inputs.artifact-cluster-name != ''
        run: |
          cat "cache/clusters/${{ inputs.artifact-cluster-name }}/image-registry-login" | bash
          ./update-pull-secret.sh --cluster "${{ inputs.cluster-name }}" --docker-config $DOCKER_CONFIG

      - name: Check images
        run: |
          echo "ðŸ” Checking images..."          

          # Check catalog image (required)
          echo "Checking catalog image: ${{ needs.process-inputs.outputs.catalog-image }}"
          if docker pull "${{ needs.process-inputs.outputs.catalog-image }}"; then
            echo "âœ… Successfully pulled catalog image."
          else
            echo "âŒ Failed to pull catalog image."
            exit 1
          fi
          
          # Check optional images:
          declare -A IMAGES=(
            ["operator"]="${{ inputs.operatorImage }}"
            ["app"]="${{ inputs.appImage }}"
            ["ui"]="${{ inputs.uiImage }}"
          )
          
          for IMAGE_TYPE in "${!IMAGES[@]}"; do
            IMAGE_URL="${IMAGES[$IMAGE_TYPE]}"
            if [[ -n "$IMAGE_URL" ]]; then
              echo "Checking $IMAGE_TYPE image: $IMAGE_URL"
              if docker pull "$IMAGE_URL"; then
                echo "âœ… Successfully pulled $IMAGE_TYPE image."
              else
                echo "âŒ Failed to pull $IMAGE_TYPE image."
                exit 1
              fi
            else
              echo "â„¹ï¸  ${IMAGE_TYPE^} image not provided, skipping check."
            fi
          done
          
          echo "âœ… All image checks completed successfully."

      - name: Configure operator install file
        run: |
          ./configure-apicurio-operator-install-file.sh --cluster ${{ inputs.cluster-name }} \
            --version ${{ inputs.release-version }} \
            --namespace PLACEHOLDER_NAMESPACE \
            --operatorImage "${{ inputs.operatorImage }}" \
            --appImage "${{ inputs.appImage }}" \
            --uiImage "${{ inputs.uiImage }}"

      - name: Checkout Registry
        run: |
          git clone --branch ${{ inputs.tests-tag }} --depth 1 https://github.com/Apicurio/apicurio-registry.git

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin
          cache: maven
          cache-dependency-path: |
            apicurio-registry/operator/pom.xml
            apicurio-registry/operator/**/pom.xml

      - name: Run remote tests
        working-directory: apicurio-registry/operator
        run: |
          mvn -B verify -pl controller -am \
            -DskipOperatorTests=false \
            -Dtest.operator.deployment-type=remote \
            -Dtest.operator.install-file=$WORKSPACE/templates/registry-operator/${{ inputs.release-version }}/apicurio-registry-operator-configured.yaml \
            -Dtest.operator.ingress-host=$INGRESS_HOST

      - name: Check OLM v1 support
        run: |
          if kubectl get crd clusterextensions.olm.operatorframework.io &>/dev/null; then
            echo "âœ… OLM v1 (ClusterExtension CRD) is supported."
            echo "OLM_V1_SUPPORTED=true" >> $GITHUB_ENV
          else
            echo "âŒ OLM v1 (ClusterExtension CRD) is NOT supported"
            echo "OLM_V1_SUPPORTED=false" >> $GITHUB_ENV
          fi

      - name: Run OLM v1 tests
        if: env.OLM_V1_SUPPORTED == 'true'
        working-directory: apicurio-registry/operator
        run: |
          mvn -B verify -pl olm-tests -am \
            -DskipOperatorTests=false \
            -Dtest.operator.olm-version=1 \
            -Dtest.operator.catalog-image=${{ needs.process-inputs.outputs.catalog-image }} \
            -Dregistry.version=${{ inputs.package-version }}

      - name: Run OLM v0 tests
        working-directory: apicurio-registry/operator
        run: |
          mvn -B verify -pl olm-tests -am \
            -DskipOperatorTests=false \
            -Dtest.operator.catalog-image=${{ needs.process-inputs.outputs.catalog-image }} \
            -Dregistry.version=${{ inputs.package-version }}


  destroy-cluster:
    name: Destroy cluster
    uses: ./.github/workflows/infra-destroy-cluster.yaml
    needs: test
    if: >-
      !cancelled() && !inputs.skip-provision-cluster && inputs.destroy-test-cluster
    with:
      cluster-name: ${{ inputs.cluster-name }}
    secrets: inherit


  save_workflow_metadata:
    name: Save Workflow Metadata
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      - record-start-time
      - destroy-cluster
    if: >-
      !cancelled() && needs.record-start-time.result == 'success'
    steps:

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Commit workflow metadata to repository
        uses: ./.github/actions/commit-workflow-metadata
        with:
          github-token: ${{ secrets.ACCESS_TOKEN }}
          workflow-start-time: ${{ needs.record-start-time.outputs.start-time }}
