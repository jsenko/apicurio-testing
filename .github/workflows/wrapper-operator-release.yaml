name: "[Wrapper] [Test] Operator Release"
on:
  workflow_dispatch:
    inputs:
      version:
        description: Release version to test
        required: true
        type: string
      operatorImage:
        description: Operator image to test (optional)
        required: false
        type: string
      appImage:
        description: Application image to test (optional)
        required: false
        type: string
      uiImage:
        description: UI image to test (optional)
        required: false
        type: string
      indexImageOcp416:
        description: Operator index image for OCP 4.16
        required: true
        type: string
      indexImageOcp420:
        description: Operator index image for OCP 4.20
        required: true
        type: string
      packageVersion:
        description: CSV package version (e.g., 3.1.4-r1)
        required: true
        type: string
      artifactClusterName:
        description: Artifact cluster name
        required: false
        type: string
        default: art
      issueNumber:
        description: Release tracker issue number in apicurio/rhboar-releases
        required: true
        type: string
      stepId:
        description: Release step ID
        required: false
        type: string
        default: qe-operator-aws

jobs:
  run-operator-tests:
    name: Run Operator Tests
    uses: ./.github/workflows/test-registry-operator.yaml
    with:
      release-version: ${{ inputs.version }}
      tests-tag: ${{ inputs.version }}
      operatorImage: ${{ inputs.operatorImage }}
      appImage: ${{ inputs.appImage }}
      uiImage: ${{ inputs.uiImage }}
      artifact-cluster-name: ${{ inputs.artifactClusterName }}
      catalog-images: "4.16=${{ inputs.indexImageOcp416 }},4.20=${{ inputs.indexImageOcp420 }}"
      package-version: ${{ inputs.packageVersion }}
    secrets: inherit

  report-results:
    name: Report Results to Release Issue
    runs-on: ubuntu-latest
    needs: run-operator-tests
    if: always()

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Determine test result
        id: result
        run: |
          if [[ "${{ needs.run-operator-tests.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=✅" >> $GITHUB_OUTPUT
            echo "message=**QE Operator Tests (AWS) Succeeded**" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=❌" >> $GITHUB_OUTPUT
            echo "message=**QE Operator Tests (AWS) Failed**" >> $GITHUB_OUTPUT
          fi

      - name: Get workflow run details
        id: workflow-details
        run: |
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "workflow_url=$WORKFLOW_URL" >> $GITHUB_OUTPUT

      - name: Post result comment to release issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACCESS_TOKEN }}
          script: |
            const emoji = '${{ steps.result.outputs.emoji }}';
            const message = '${{ steps.result.outputs.message }}';
            const version = '${{ inputs.version }}';
            const workflowUrl = '${{ steps.workflow-details.outputs.workflow_url }}';
            const stepId = '${{ inputs.stepId }}';
            const status = '${{ steps.result.outputs.status }}';

            let command;
            if (status === 'success') {
              command = `/complete ${stepId} report_url=${workflowUrl}`;
            } else {
              command = `/fail ${stepId}`;
            }

            const commentBody = `${emoji} ${message}

            **Version:** ${version}

            **Workflow Run**
            * ${workflowUrl}

            ---

            ${command}`;

            await github.rest.issues.createComment({
              owner: 'apicurio',
              repo: 'rhboar-releases',
              issue_number: ${{ inputs.issueNumber }},
              body: commentBody
            });

      - name: Fail job if tests failed
        if: steps.result.outputs.status == 'failure'
        run: |
          echo "QE operator tests failed. Failing this job."
          exit 1
