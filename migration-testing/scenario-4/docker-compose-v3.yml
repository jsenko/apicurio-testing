services:
  postgres-v3:
    image: postgres:14
    container_name: scenario4-postgres-v3
    environment:
      POSTGRES_DB: registry
      POSTGRES_USER: apicurio
      POSTGRES_PASSWORD: apicurio123
    ports:
      - "5433:5432"
    volumes:
      - postgres-v3-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U apicurio -d registry"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - scenario4-v3

  apicurio-registry-v3:
    image: apicurio/apicurio-registry:3.1.2
    container_name: scenario4-registry-v3
    ports:
      - "3333:8443"
    volumes:
      - ./certs:/certs:ro
    environment:
      # Database configuration (v3.x style)
      APICURIO_DATASOURCE_URL: 'jdbc:postgresql://postgres-v3:5432/registry'
      APICURIO_DATASOURCE_USERNAME: apicurio
      APICURIO_DATASOURCE_PASSWORD: apicurio123
      APICURIO_STORAGE_KIND: "sql"
      APICURIO_STORAGE_SQL_KIND: "postgresql"

      # TLS/HTTPS configuration
      QUARKUS_HTTP_SSL_PORT: 8443
      QUARKUS_HTTP_SSL_CERTIFICATE_KEY_STORE_FILE: /certs/registry-keystore.p12
      QUARKUS_HTTP_SSL_CERTIFICATE_KEY_STORE_PASSWORD: registry123
      QUARKUS_HTTP_INSECURE_REQUESTS: disabled

      # OIDC/Authentication configuration
      QUARKUS_OIDC_TENANT_ENABLED: "true"
      QUARKUS_OIDC_AUTH_SERVER_URL: "https://scenario4-keycloak:8443/realms/registry"
      QUARKUS_OIDC_CLIENT_ID: "registry-api"
      apicurio.auth.role-based-authorization: "true"
      QUARKUS_OIDC_TLS_VERIFICATION: "none"

      # API configuration
      apicurio.rest.deletion.group.enabled: "true"
      apicurio.rest.deletion.artifact.enabled: "true"
      apicurio.rest.deletion.artifact-version.enabled: "true"

      # CORS (allow connections from nginx and clients)
      QUARKUS_HTTP_CORS_ORIGINS: "*"
    depends_on:
      postgres-v3:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:8443/health/live"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - scenario4-v3
      - scenario4-keycloak-network

volumes:
  postgres-v3-data:
    name: scenario4-postgres-v3-data

networks:
  scenario4-v3:
    name: scenario4-v3-network
    external: true
  scenario4-keycloak-network:
    name: scenario4-keycloak-network
    external: true
